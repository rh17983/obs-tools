<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Website Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    :root {
      --ok: #116149; --ok-bg: #e6f4ef;
      --bad: #8a1c1c; --bad-bg: #fde8e8;
      --border: #e3e3e3; --muted:#666; --link:#0a66c2;
    }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; margin: 24px; color:#111; }
    h1 { text-align:center; font-size:1.1rem; letter-spacing:.4px; margin:0 0 20px; }
    details.region { border-top:1px solid var(--border); padding-top:12px; margin-top:18px; }
    details.region[open] summary::before { transform: rotate(90deg); }
    details.region summary { list-style:none; cursor:pointer; font-weight:700; font-size:1.05rem; }
    details.region summary::marker { display:none; }
    details.region summary::before { content:"›"; display:inline-block; margin-right:8px; color:var(--muted); transition:transform .15s; }
    .sites { display:flex; flex-wrap:wrap; gap:12px 18px; margin-top:10px; }
    .site { display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; padding:8px 12px; position:relative; }
    .site a { text-decoration:none; color:var(--link); font-weight:600; }
    .badge { font-size:.82rem; padding:3px 8px; border-radius:999px; border:1px solid transparent; }
    .ok { color:var(--ok); background:var(--ok-bg); border-color:#cde7df; }
    .bad { color:var(--bad); background:var(--bad-bg); border-color:#f6caca; }
    .info-btn {
      background:#eee; border:none; border-radius:50%; width:20px; height:20px;
      text-align:center; cursor:pointer; font-size:12px; color:#444; line-height:1;
    }
    .info-popup {
      display:none;
      position:absolute;
      top:36px; left:12px;
      background:white;
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px 10px;
      font-size:0.85rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      z-index:10;
    }
    .info-popup.visible { display:block; }
    .error { color:var(--bad); background:var(--bad-bg); border:1px solid #f6caca; padding:10px 12px; border-radius:10px; max-width:900px; margin:12px auto; }
  </style>
</head>
<body>
  <h1>Avaloq Observability Tools</h1>
  <div id="errors"></div>
  <main id="content"></main>

  <script>
    const FILE_NAME = 'links-out.yaml'; // same folder as this HTML

    function showError(msg) {
      const div = document.getElementById('errors');
      const p = document.createElement('div');
      p.className = 'error';
      p.textContent = msg;
      div.appendChild(p);
    }

    function isOk(status) {
      if (!status) return false;
      if (typeof status === 'object' && 'ok' in status) return !!status.ok;
      if (typeof status === 'string') return /^ok|^available|^200/i.test(status);
      return false;
    }

    function render(data) {
      const root = document.getElementById('content');
      root.innerHTML = '';

      if (!Array.isArray(data)) {
        showError('YAML root must be an array of region objects.');
        return;
      }

      data.forEach(regionObj => {
        if (!regionObj || typeof regionObj !== 'object') return;
        const region = Object.keys(regionObj)[0];
        const sites = regionObj[region];

        const details = document.createElement('details');
        details.className = 'region';
        details.open = true;

        const summary = document.createElement('summary');
        summary.textContent = region || 'Unknown Region';
        details.appendChild(summary);

        const row = document.createElement('div');
        row.className = 'sites';

        if (Array.isArray(sites)) {
          sites.forEach(siteEntry => {
            if (!siteEntry || typeof siteEntry !== 'object') return;
            const name = Object.keys(siteEntry)[0];
            const meta = siteEntry[name] || {};
            const link = meta.link || '#';
            const status = meta.status || {};
            const ok = isOk(status);
            const statusCode = status.code ?? '—';
            const reason = status.reason ?? '—';

            const item = document.createElement('div');
            item.className = 'site';

            const a = document.createElement('a');
            a.href = link;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = name || '(unnamed)';
            item.appendChild(a);

            const badge = document.createElement('span');
            badge.className = 'badge ' + (ok ? 'ok' : 'bad');
            badge.textContent = ok ? 'Available' : 'Not Available';
            item.appendChild(badge);

            // info button
            const infoBtn = document.createElement('button');
            infoBtn.className = 'info-btn';
            infoBtn.textContent = 'ⓘ';
            item.appendChild(infoBtn);

            // hidden popup
            const popup = document.createElement('div');
            popup.className = 'info-popup';
            popup.innerHTML = `
              <div><strong>Status Code:</strong> ${statusCode}</div>
              <div><strong>Reason:</strong> ${reason}</div>
            `;
            item.appendChild(popup);

            infoBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              popup.classList.toggle('visible');
            });

            // hide popups when clicking outside
            document.addEventListener('click', (e) => {
              if (!item.contains(e.target)) popup.classList.remove('visible');
            });

            row.appendChild(item);
          });
        }

        details.appendChild(row);
        root.appendChild(details);
      });
    }

    async function loadAndRender() {
      try {
        const res = await fetch(FILE_NAME, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} while fetching ${FILE_NAME}`);
        const text = await res.text();
        let data;
        try { data = jsyaml.load(text); }
        catch (e) { data = JSON.parse(text); }
        render(data);
      } catch (e) {
        showError(e.message || String(e));
      }
    }

    loadAndRender();
  </script>
</body>
</html>
